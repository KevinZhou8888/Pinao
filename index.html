<!DOCTYPE html>
<html>
    <head>
        <title>pinao</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
        <link href="pinao.css" rel="stylesheet" />
    </head>
    <body>
        <div class="123" style="height: 25vh"></div>
        <div id="functionLine">
            <button id="clear">清空</button>
            <button id="biaoji" val="F">标记</button>
            <button id="bofang">播放</button>
            <button id="down">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-chevron-left"
                    viewBox="0 0 16 16"
                >
                    <path
                        fill-rule="evenodd"
                        d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"
                    />
                </svg>
            </button>
            <button id="up">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-chevron-right"
                    viewBox="0 0 16 16"
                >
                    <path
                        fill-rule="evenodd"
                        d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"
                    />
                </svg>
            </button>
        </div>
        <div class="container">
            <div class="keys">
                <!-- 一个八度 -->
                <div class="key while" val="C" octave="1">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="1">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="1">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="1">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="1">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="1">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="1">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="1">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="1">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="1">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="1">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="1">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->

                <!-- 一个八度 -->
                <div class="key while" val="C" octave="2">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="2">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="2">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="2">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="2">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="2">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="2">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="2">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="2">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="2">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="2">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="2">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->

                <!-- 一个八度 -->
                <div class="key while" val="C" octave="3">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="3">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="3">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="3">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="3">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="3">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="3">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="3">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="3">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="3">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="3">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="3">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->

                <!-- 一个八度 -->
                <div class="key while" val="C" octave="4">
                    <span class="key name"
                        ><b style="color: rgb(255, 0, 0)">C</b></span
                    >
                </div>
                <div class="key black" val="#C" octave="4">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="4">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="4">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="4">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="4">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="4">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="4">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="4">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="4">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="4">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="4">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->

                <!-- 一个八度 -->
                <div class="key while" val="C" octave="5">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="5">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="5">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="5">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="5">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="5">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="5">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="5">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="5">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="5">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="5">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="5">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->

                <!-- 一个八度 -->
                <div class="key while" val="C" octave="6">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="6">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="6">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="6">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="6">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="6">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="6">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="6">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="6">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="6">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="6">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="6">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->
                <!-- 一个八度 -->
                <div class="key while" val="C" octave="7">
                    <span class="key name">C</span>
                </div>
                <div class="key black" val="#C" octave="7">
                    <span class="key name">#C<br />bD</span>
                </div>
                <div class="key while" val="D" octave="7">
                    <span class="key name">D</span>
                </div>
                <div class="key black" val="#D" octave="7">
                    <span class="key name">#D<br />bE</span>
                </div>
                <div class="key while" val="E" octave="7">
                    <span class="key name">E</span>
                </div>
                <div class="key while" val="F" octave="7">
                    <span class="key name">F</span>
                </div>
                <div class="key black" val="#F" octave="7">
                    <span class="key name">#F<br />bG</span>
                </div>
                <div class="key while" val="G" octave="7">
                    <span class="key name">G</span>
                </div>
                <div class="key black" val="#G" octave="7">
                    <span class="key name">#G<br />bA</span>
                </div>
                <div class="key while" val="A" octave="7">
                    <span class="key name">A</span>
                </div>
                <div class="key black" val="#A" octave="7">
                    <span class="key name">#A<br />bB</span>
                </div>
                <div class="key while" val="B" octave="7">
                    <span class="key name">B</span>
                </div>
                <!-- 一个八度 -->
            </div>
            <div class="guide">
                <div class="guideLine">1</div>
                <div class="guideLine">2</div>
                <div class="guideLine">3</div>
                <div class="guideLine">4</div>
                <div class="guideLine">5</div>
                <div class="guideLine">6</div>
                <div class="guideLine">7</div>
            </div>

            <script>
                //音名的奇妙等效转换
                var map = {
                    "#A": "Bb",
                    "#C": "Db",
                    "#D": "Eb",
                    "#F": "Gb",
                    "#G": "Ab",
                };

                //八度内音名转数字
                var map_value = {
                    C: 1,
                    "#C": 2,
                    D: 3,
                    "#D": 4,
                    E: 5,
                    F: 6,
                    "#F": 7,
                    G: 8,
                    "#G": 9,
                    A: 10,
                    "#A": 11,
                    B: 12,
                };

                //八度内数字转音名
                var remap_value = {
                    1: "C",
                    2: "#C",
                    3: "D",
                    4: "#D",
                    5: "E",
                    6: "F",
                    7: "#F",
                    8: "G",
                    9: "#G",
                    10: "A",
                    11: "#A",
                    12: "B",
                };

                var map_interval = {
                    0: "一度",
                    1: "小二度",
                    2: "大二度",
                    3: "小三度",
                    4: "大三度",
                    5: "纯四度",
                    6: "增四度", //或减五度
                    7: "纯五度",
                    8: "小六度",
                    9: "大六度",
                    10: "小七度",
                    11: "大七度",
                    12: "八度",
                    13: "小九度",
                };
                //按下的音符列表，以数字的形式保存
                var click_list = [];

                //八度内数字 加上 （八度数*12）算出总数字
                function tran_val(key_value, octave) {
                    return map_value[key_value] + 12 * (octave - 1);
                }

                //总数字回算八度内音名和八度数
                function retran_val(key_num) {
                    if (key_num % 12 == 0) {
                        var key_val = remap_value[12];
                        var octave = parseInt(key_num / 12);
                        return [key_val, octave];
                    } else {
                        var key_val = remap_value[key_num % 12];
                        var octave = parseInt(key_num / 12) + 1;
                        return [key_val, octave];
                    }
                }

                //播放音频 输入音名+八度数
                function playSound(key_value, octave) {
                    var url =
                        "scr/" +
                        key_value.toString() +
                        octave.toString() +
                        ".mp3";
                    new Audio(url).play();
                }
                // 播放和声
                function playHarmony(list) {
                    for (let i = 0; i < list.length; i++) {
                        var key_num = list[i];
                        var key_val = retran_val(key_num);
                        console.log(list);
                        console.log(key_val);
                        if (key_val[0][0] == "#") {
                            playSound(map[key_val[0]], key_val[1]);
                        } else {
                            playSound(key_val[0], key_val[1]);
                        }
                    }
                }
                //通过列表标记琴键
                function draw(list) {
                    for (let i = 0; i < list.length; i++) {
                        draw_Key(findKey(list[i]));
                    }
                }
                // 编写音程+音符关系
                function write_span(list) {
                    var str = "";
                    var key_val;
                    var str2 = "";
                    var interval2;
                    $(".key_interval").remove();
                    $(".key_interval2").remove();
                    for (let i = 0; i < list.length; i++) {
                        key_val = retran_val(list[i]);
                        var div = $("<div></div>");
                        div.attr("class", "key_interval");
                        str =
                            key_val[0].toString() +
                            "<small>" +
                            key_val[1].toString() +
                            "</small>";

                        div.html(str);
                        $("#functionLine").append(div);
                        if (i < list.length - 1) {
                            interval = list[i + 1] - list[i];
                            if (interval <= 12) {
                                str2 = map_interval[interval];
                            } else {
                                var oct = parseInt(interval / 12);
                                var int = interval % 12;
                                if (int == 0) {
                                    str2 = oct.toString() + "*八度";
                                } else {
                                    str2 =
                                        oct.toString() +
                                        "*八度" +
                                        "+" +
                                        map_interval[int];
                                }
                            }
                            var div2 = $("<div></div>");
                            div2.attr("class", "key_interval2");
                            div2.html(str2);
                            $("#functionLine").append(div2);
                        }
                    }
                }

                //通过总数字找获取琴键
                function findKey(num) {
                    var key_val = retran_val(num);
                    var cond =
                        "[val=" + key_val[0] + "][octave=" + key_val[1] + "]";
                    return $(cond);
                }

                //标记琴键
                function draw_Key(obj) {
                    obj.css("background", "#fd820f");
                    obj.children().css("color", "rgb(255, 255, 255)");
                    obj.attr("isClick", "T");
                }

                //去掉标记(白键)
                function draw_back(obj) {
                    obj.css("background", "linear-gradient(#fff 96%, #eee 4%)");
                    obj.attr("isClick", "F");
                    obj.children().css("color", "#838383");
                }

                //去掉标记（黑键）
                function draw_back_blackKey(obj) {
                    obj.css("background", "linear-gradient(#333, #000)");
                    obj.children().css("color", "#838383");
                    obj.attr("isClick", "F");
                }

                //去掉所有标记
                function clear_all() {
                    $(".key.black").attr("isClick", "F");
                    $(".key.black").css(
                        "background",
                        "linear-gradient(#333, #000)"
                    );
                    $(".key.black").children().css("color", "#838383");

                    $(".key.while").attr("isClick", "F");
                    $(".key.while").css(
                        "background",
                        "linear-gradient(#fff 96%, #eee 4%)"
                    );
                    $(".key.while").children().css("color", "#838383");
                }

                $(document).ready(function () {
                    //添加标记标签
                    $(".key.while").attr("isClick", "F");

                    //白键在标记状态下的样式变化+数字记录
                    $(".key.while").click(function () {
                        if ($("#biaoji").attr("val") == "F") {
                            return;
                        }
                        var val = $(this).attr("val");
                        var key = $(this);
                        var octave = key.attr("octave");
                        var key_val = key.attr("val");
                        var key_num = tran_val(key_val, octave);

                        if ($(this).attr("isClick") == "F") {
                            draw_Key($(this));

                            click_list.push(key_num);
                            click_list.sort(function (a, b) {
                                return a - b;
                            });
                            write_span(click_list);

                            $(this).attr("isClick", "T");
                        } else {
                            draw_back($(this));
                            var index = click_list.indexOf(key_num);
                            click_list.splice(index, 1);
                            write_span(click_list);

                            $(this).attr("isClick", "F");
                        }
                    });

                    //白键 播放音频
                    $(".key.while").click(function () {
                        var key = $(this);
                        var octave = key.attr("octave");
                        var key_val = key.attr("val");
                        playSound(key_val, octave);
                    });
                    //黑键 播放音频
                    $(".key.black").click(function () {
                        var key = $(this);
                        var octave = key.attr("octave");
                        var key_val = key.attr("val");
                        playSound(map[key_val], octave);
                    });
                    //黑键 添加标记标签
                    $(".key.black").attr("isClick", "F");
                    //黑键 在标记状态下 按下的样式变换+数字记录
                    $(".key.black").click(function () {
                        if ($("#biaoji").attr("val") == "F") {
                            return;
                        }

                        var key = $(this);
                        var octave = key.attr("octave");
                        var key_val = key.attr("val");
                        var key_num = tran_val(key_val, octave);

                        var val = $(this).attr("val");
                        if ($(this).attr("isClick") == "F") {
                            draw_Key($(this));
                            click_list.push(key_num);
                            click_list.sort(function (a, b) {
                                return a - b;
                            });
                            write_span(click_list);

                            $(this).attr("isClick", "T");
                        } else {
                            draw_back_blackKey($(this));
                            var index = click_list.indexOf(key_num);
                            click_list.splice(index, 1);
                            write_span(click_list);

                            $(this).attr("isClick", "F");
                        }
                    });
                    //标记按钮
                    $("#biaoji").click(function () {
                        var value = $(this).attr("val");
                        // 清空标记状态
                        clear_all();
                        if (value == "T") {
                            $(this).css("background-color", "#000000");
                            $(this).css("color", "#fff");
                            //清空标记列表
                            click_list.splice(0, click_list.length);
                            write_span(click_list);

                            $(this).attr("val", "F");
                        } else {
                            $(this).css("background-color", "#ff9d41");
                            $(this).css("border", "#ff9d41");
                            $(this).css("color", "#000");
                            $(this).attr("val", "T");
                        }
                    });
                    // 清空按钮
                    $("#clear").click(function () {
                        click_list.splice(0, click_list.length);
                        write_span(click_list);

                        clear_all();
                    });

                    $("#bofang").click(function () {
                        playHarmony(click_list);
                    });

                    $("#up").click(function () {
                        for (let i = 0; i < click_list.length; i++) {
                            click_list[i]++;
                        }
                        clear_all();
                        console.log(click_list);
                        write_span(click_list);
                        draw(click_list);
                        playHarmony(click_list);
                    });

                    $("#down").click(function () {
                        for (let i = 0; i < click_list.length; i++) {
                            click_list[i]--;
                        }
                        clear_all();
                        console.log(click_list);
                        write_span(click_list);
                        draw(click_list);
                        playHarmony(click_list);
                    });
                });
            </script>
        </div>
        <div class="display"></div>
    </body>
</html>
